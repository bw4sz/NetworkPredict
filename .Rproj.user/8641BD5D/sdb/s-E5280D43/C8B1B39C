{
    "contents" : "---\ntitle: \"Observed2M_Model\"\nauthor: \"Ben Weinstein\"\ndate: \"June 6, 2016\"\noutput: html_document\n---\n\n```{r,warning=FALSE,message=FALSE,echo=FALSE,cache=FALSE}\nlibrary(reshape2)\nlibrary(foreach)\nlibrary(doSNOW)\nlibrary(chron)\nlibrary(ggplot2)\nlibrary(knitr)\nlibrary(R2jags)\nlibrary(dplyr)\nlibrary(stringr)\nlibrary(gridExtra)\nlibrary(boot)\nlibrary(picante)\nlibrary(bipartite)\n\nopts_chunk$set(message=FALSE,warning=FALSE,fig.width=10,fig.height=7,echo=TRUE,cache=F,fig.align='center',fig.path=\"figureObserved/\")\n\nset.seed(3)\n\n#source functions\nsource(\"Bayesian/BayesFunctions.R\")\n```\n\n```{r,echo=F,cache=FALSE}\npaste(\"Run Completed at\",Sys.time())\n```\n\n```{r}\n#Load in data from Observed2m_Generate.Rmd\nload(\"Observed.RData\")\n```\n\n#View Raw Data\n```{r}\nggplot(indat,aes(x=Traitmatch,y=Yobs,col=Survey_Type)) + facet_wrap(~Hummingbird,ncol=1) + geom_point() + geom_smooth(method = \"glm\",method.args=list(family=\"binomial\"))\nglm(data=indat,Yobs~Traitmatch,family=\"binomial\")\n```\n\n#Hierarchical Occupancy Model\n\nFor hummingbird species i feeding on plant species j observed at time k and sampling event d. \n\n$$ YTransect_{i,j,k,d} \\sim Bernoulli(\\omega_{Transect}) $$\n$$ YCamera_{i,j,k,d} \\sim Bernoulli(\\omega_{Camera}) $$\n$$ \\omega_{Camera} <- \\phi_{Camera} * EffortCamera_k $$\n$$ \\omega_{Transect} <- \\phi_{Transect}* EffortTransect_k $$\n$$ p_{i,j,k} \\sim Bernoulli(\\rho_{i,j,k}) $$\n$$ logit(\\rho_{i,j,k}) = \\alpha_i + \\beta_{1,i} * Traitmatch_{i,j} + \\beta_{2,i} *Resources_k + \\beta_{3,i} * Traitmatch_{i,j} * Resources_k $$\n\n**Priors**\n\n$$ \\phi_{Camera} \\sim U(0,1) $$\n$$ \\phi_{Transect} \\sim U(0,1) $$\n$$\\alpha_i \\sim Normal(\\alpha_mu,\\alpha_\\tau)$$\n$$\\beta_{1,i} \\sim Normal(\\mu_\\beta_1,\\tau_beta_1)$$\n$$\\beta_{2,i} \\sim Normal(\\mu_\\beta_2,\\tau_beta_2)$$\n$$\\beta_{3,i} \\sim Normal(\\mu_\\beta_3,\\tau_beta_3)$$\n\n**Hyperpriors**\n\nGroup Level Means\n$$ \\mu_\\alpha \\sim Normal(0,0.0001)$$\n$$\\mu_\\beta_1 \\sim Normal(0,0.0001)$$\n$$\\mu_\\beta_2 \\sim Normal(0,0.0001)$$\n$$\\mu_\\beta_3 \\sim Normal(0,0.0001)$$\n\nGroup Level Variance\n\n$$\\tau_\\alpha \\sim Half-Cauchy(0,1,1)$$\n$$\\tau_\\beta_1 \\sim Half-Cauchy(0,1,1)$$\n$$\\tau_\\beta_2 \\sim Half-Cauchy(0,1,1)$$\n$$\\tau_\\beta_3 \\sim Half-Cauchy(0,1,1)$$\n\n```{r,eval=T,strip.white=T}\n\n#Source model\nsource(\"Bayesian/NmixturePoissonRagged2m.R\")\n\n#print model\nwriteLines(readLines(\"Bayesian/NmixturePoissonRagged2m.R\"))\n\n#Input Data\nDat <- c('Yobs_camera','Yobs_transect','Birds','Bird','Plant','Time','Plants','Times','resources','Nobs','cam_surveys','trans_surveys','Traitmatch')\n\n#Inits\nInitStage <- function(){\n  #A blank Y matrix - all present\n  initY<-array(dim=c(Birds,Plants,Times),1)\nlist(S=initY)}\n\n#Parameters to track\nParsStage <- c(\"alpha\",\"beta1\",\"alpha_mu\",\"alpha_sigma\",\"beta1_sigma\",\"beta1_mu\",\"dtrans\",\"dcam\")\n\n\n#Jags Data\n\n  Yobs_camera = indat$Camera\n  Yobs_transect = indat$Transect\n  Birds=max(indat$jBird)\n  Bird=indat$jBird\n  Plant=indat$jPlant\n  Time=indat$jTime\n  Plants=max(indat$jPlant)\n  Times=max(indat$jTime)\n  resources=resourceMatrix\n  Nobs=nrow(indat)\n  cam_surveys= (indat$Survey_Type==\"Camera\")*1\n  trans_surveys= (indat$Survey_Type==\"Transect\")*1\n  Traitmatch=jTraitmatch\n\n  #MCMC options\n  system.time(m2<-jags(data=Dat,parameters.to.save =ParsStage,inits=InitStage,model.file=\"Bayesian/NmixturePoissonRagged2m.jags\",n.thin=2,n.iter=40000,n.burnin=39000,n.chains=2,DIC=F))\n```\n\n```{r,eval=F}\n#recompile if needed\nload.module(\"dic\")\nruns<-40000\nrecompile(m2)\nm2<-update(m2,n.iter=runs,n.burnin=runs*.9,n.thin=3)\n```\n\n```{r}\n#extract par to data.frame\npars_detect<-extract_par(m2,data=indat,Bird=\"jBird\",Plant=\"jPlant\")\n```\n\n##Assess Convergence\n\n```{r,cache=FALSE,fig.width=13,fig.height=5}\n###Chains\nggplot(pars_detect[pars_detect$par %in% c(\"alpha\",\"beta1\"),],aes(x=Draw,y=estimate,col=as.factor(Chain))) + geom_line() + facet_grid(par~species,scale=\"free\") + theme_bw() + labs(col=\"Chain\") + ggtitle(\"Species Level\")\n```\n\n```{r,fig.height=10}\nggplot(pars_detect[pars_detect$par %in% c(\"dcam\",\"dtrans\"),],aes(x=Draw,y=estimate,col=as.factor(Chain))) + geom_line() + facet_wrap(~par,scale=\"free\",ncol=4) + theme_bw() + labs(col=\"Chain\") + ggtitle(\"Species Level\")\n```\n\n```{r,fig.height=5,fig.width=11}\nggplot(pars_detect[pars_detect$par %in% c(\"beta_mu\",\"beta_sigma\",\"alpha_mu\",\"alpha_sigma\"),],aes(x=Draw,y=estimate,col=as.factor(Chain))) + geom_line() + theme_bw() + labs(col=\"Chain\") + ggtitle(\"Group Level Parameters\") + facet_wrap(~par,scales=\"free\")\n```\n\n#Posteriors\n\n```{r,cache=FALSE,fig.width=11,fig.height=14}\n###Posterior Distributions\nggplot(pars_detect[pars_detect$par %in% c(\"alpha\",\"beta1\"),],aes(x=estimate)) + geom_histogram(position='identity') +  facet_grid(species~par,scales=\"free\") + theme_bw() + ggtitle(\"Species Parameters\")\n#overlay priors\n```\n\n```{r,cache=FALSE,fig.width=10,fig.height=10}\n#Detection figure\nggplot(pars_detect[pars_detect$par %in% c(\"dtrans\",\"dcam\"),],aes(x=par,y=estimate)) + geom_violin(fill='black') + theme_bw() + ggtitle(\"Detection Probability\") + scale_x_discrete(labels=c(\"Camera\",\"Transect\"))\n```\n\n```{r,cache=FALSE,fig.height=5,fig.width=13}\nggplot(pars_detect[pars_detect$par %in% c(\"beta1_mu\",\"beta1_sigma\",\"alpha_mu\",\"alpha_sigma\"),],aes(x=estimate)) + geom_histogram() + ggtitle(\"Group Level Posteriors\") + facet_wrap(~par,scale=\"free\",nrow=2) + theme_bw() \n```\n\n#Predicted Relationship \n\n```{r,fig.height=4,fig.width=4}\n#Expand out pars\ncastdf<-dcast(pars_detect[pars_detect$par %in% c(\"beta1_mu\",\"alpha_mu\"),], Chain + Draw~par,value.var=\"estimate\")\n```\n\n## Posterior prediction\n\n```{r,fig.width=7,fig.height=6}\n#Trajectories from posterior\npredy<-trajF(alpha=castdf$alpha_mu,beta1=castdf$beta1_mu,x=indat$Traitmatch,resources=indat$scaledR,beta2=0,beta3=0,type='quantile')\n\nggplot(data=predy,aes(x=x)) + geom_ribbon(aes(ymin=lower,ymax=upper),alpha=0.4,fill=\"red\")  +  theme_bw() + ylab(\"Interactions\") + xlab(\"Difference between Bill and Corolla Length\") + geom_point(data=indat,aes(x=Traitmatch,y=Camera)) + geom_line(aes(y=mean)) + geom_point(data=indat,aes(x=Traitmatch,y=Transect)) \n```\n\n## At High and Low Resource Availability\n\n```{r,fig.height=6,fig.width=10}\n\n#Trajectories from posterior\npredH<-trajF(alpha=castdf$alpha_mu,beta1=castdf$beta1_mu,x=indat[indat$ BUsed_Flowers==1,\"Traitmatch\"],resources=indat[indat$ BUsed_Flowers==1,\"scaledR\"],beta2=0,beta3=0,type='quantile')\n\npredL<-trajF(alpha=castdf$lintercept,beta1=castdf$lgamma1,x=indat[indat$ BUsed_Flowers==0,\"Traitmatch\"],resources=indat[indat$ BUsed_Flowers==0,\"scaledR\"],beta2=0,beta3=0,type='quantile')\n\npredhl<-melt(list(High=predH,Low=predL),id.vars=colnames(predH))\n\ncolnames(predhl)[5]<-\"BFlowerL\"\n\nindat$BFlowerL<-factor(as.character(indat$ BUsed_Flowers))\nlevels(indat$BFlowerL)<-c(\"Low\",\"High\")\n\nggplot(data=predhl,aes(x=x)) + geom_ribbon(aes(ymin=lower,ymax=upper,fill=BFlowerL),alpha=0.2)  + geom_line(aes(y=mean,col=BFlowerL),size=.8) + theme_bw() + ylab(\"Interactions\") + xlab(\"Difference between Bill and Corolla Length\") + geom_point(data=mindat,aes(x=Traitmatch,y=value))+ labs(fill=\"Resource Availability\",col=\"Resource Availability\") \nggsave(\"Figures/AllRegression.jpeg\",height=5,width=7)\n\n```\n\n##Species Predictions\n\n```{r,fig.height=10,fig.width=11,eval=T}\n\ncastdf<-dcast(pars_detect[pars_detect$par %in% c(\"beta1\",\"alpha\"),], species +Chain +Draw ~par ,value.var=\"estimate\")\n\n#Turn to \ncastdf$species<-factor(castdf$species,levels=1:max(as.numeric(castdf$species)))\n\nspecies.split<-split(castdf,list(castdf$species),drop = T)\n\nspecies.traj<-list()\n\nfor(d in 1:length(species.split)){\n  x<-species.split[[d]]\n  index<-unique(x$species)\n  \n  #get data for those species\n  billd<-indat[indat$jBird %in% index,]\n\n  #scale resources\n  species.traj[[d]]<-trajF(alpha=x$alpha,beta1=x$beta1,beta2=0,beta3=0,resources=billd$scaledR,x=billd$Traitmatch,type='quantile')\n  }\n\nnames(species.traj)<-names(species.split)\n\nspecies.traj<-melt(species.traj,id.var=colnames(species.traj[[1]]))\n\n#split out names and model\nspecies.traj[,c(\"Index\")]<-colsplit(species.traj$L1,\"\\\\.\",c(\"Index\"))\n\nspe<-merge(species.traj,jagsIndexBird,by.x=\"Index\",by.y=\"jBird\")\n\n#plot and compare to original data\nggplot(data=spe,aes(x=x)) + geom_ribbon(aes(ymin=lower,ymax=upper),alpha=0.2,fill='red') + geom_line(aes(y=mean),size=.5) + theme_bw() + ylab(\"Occurrence Probability\")+ xlab(\"Difference between Bill and Corolla Length\") + facet_wrap(~Hummingbird,scales=\"free\",ncol=4) + geom_point(data=mindat,aes(x=Traitmatch,y=value,shape=variable),size=2.5) + labs(shape=\"Sampling Method\")\n```\n\n###Species Predictions: High and Low Availability\n\n```{r,fig.height=10,fig.width=11,eval=T}\n\ncastdf<-dcast(pars_detect[pars_detect$par %in% c(\"beta1\",\"alpha\"),], species +Chain +Draw ~par ,value.var=\"estimate\")\n\n#Turn to \ncastdf$species<-factor(castdf$species,levels=1:max(as.numeric(castdf$species)))\n\nspecies.split<-split(castdf,list(castdf$species),drop = T)\n\nspecies.traj<-list()\n\nfor(d in 1:length(species.split)){\n  x<-species.split[[d]]\n  index<-unique(x$species)\n  \n  #get data for those species\n  billd<-indat[indat$jBird %in% index,]\n\n  sl<-trajF(alpha=x$alpha,beta1=x$beta1,beta2=0,beta3=0,resources=billd[billd$ BUsed_Flowers==0,\"scaledR\"],x=billd[billd$ BUsed_Flowers==0,\"Traitmatch\"],type='quantile')\n  sh<-trajF(alpha=x$alpha,beta1=x$beta1,beta2=0,beta3=0,resources=billd[billd$ BUsed_Flowers==1,\"scaledR\"],x=billd[billd$ BUsed_Flowers==1,\"Traitmatch\"],type='quantile')\n  sm<-melt(list(High=sh,Low=sl),id.vars=colnames(sl))\n  colnames(sm)[5]<-\"Resources\"\n  species.traj[[d]]<-sm\n  }\n\nnames(species.traj)<-names(species.split)\n\nspecies.traj<-melt(species.traj,id.var=colnames(species.traj[[1]]))\n\n#split out names and model\nspecies.traj[,c(\"Index\")]<-colsplit(species.traj$L1,\"\\\\.\",c(\"Index\"))\n\nspe<-merge(species.traj,jagsIndexBird,by.x=\"Index\",by.y=\"jBird\")\n\n#plot and compare to original data\nggplot(data=spe,aes(x=x)) + geom_ribbon(aes(ymin=lower,ymax=upper,fill=Resources),alpha=0.2) + geom_line(aes(y=mean,col=Resources),size=.5) + theme_bw() + ylab(\"Occurrence Probability\")+ xlab(\"Difference between Bill and Corolla Length\") + facet_wrap(~Hummingbird,scales=\"free\",ncol=3) + geom_point(data=mindat,aes(x=Traitmatch,y=value,shape=variable),size=1.5,alpha=.5)\nggsave(\"Figures/SpeciesRegression.jpeg\",height=6,width=7)\n\n```\n\n##Species Level Interaction\n\n```{r,fig.height=11,fig.width=10,eval=F}\ncastdf<-dcast(pars_detect[pars_detect$par %in% c(\"beta1\",\"beta2\",\"beta3\",\"alpha\"),], species +Chain + Draw~par,value.var=\"estimate\")\n\n#Turn to \ncastdf$species<-factor(castdf$species,levels=1:max(as.numeric(castdf$species)))\n\nspecies.split<-split(castdf,list(castdf$species),drop = T)\n\nspecies.traj<-list()\n\nfor(d in 1:length(species.split)){\n  dat<-species.split[[d]]\n  index<-unique(dat$species)\n  \n  #get data for those species\n  billd<-mindat[mindat$jBird %in% index,]\n\n  #Calculate interaction effect\n  species.traj[[d]]<-intF(alpha=dat$alpha,beta1=dat$beta1,x=billd[billd$value > 0 & !is.na(billd$value),'Traitmatch'],resources=billd[billd$value > 0 & !is.na(billd$value),'scaledR'],beta2=0,beta3=0,type='quantile')\n  \n  }\n\nnames(species.traj)<-names(species.split)\nspecies.traj<-melt(species.traj,id.var=colnames(species.traj[[1]]))\n\n#split out names and model\nspecies.traj[,c(\"Index\")]<-colsplit(species.traj$L1,\"\\\\.\",c(\"Index\"))\n\nspe<-merge(species.traj,jagsIndexBird,by.x=\"Index\",by.y=\"jBird\")\n\n#match colnames\n\n#plot and compare to original data\nggplot(data=spe,aes(x=x)) + geom_ribbon(aes(ymin=lower,ymax=upper,fill=Hummingbird),alpha=0.3) + geom_line(aes(y=mean,col=Hummingbird),size=1) + theme_bw() + xlab(\"Difference between Bill and Corolla Length\")  + ylab(\"Effect of Resources on Trait Difference\") + facet_wrap(~Hummingbird,scales=\"free\",ncol=3)\nggsave(\"Figures/SpeciesInteraction.jpeg\",height=6,width=7)\n\n```\n\nThese plots can be tricky to interpret if one forgets that trait matching as a covariate is a distance. Therefore remember that a positive slope in the plot above indiciates, \"As resources increase species use flowers less similiar to their bill lengths\". \n\n##Interaction density functions\nLet's take a closer look at distribution of interaction effect posteriors values for each species.\n\n```{r,eval=F}\npost<-pars_detect %>% filter(par %in% \"beta3\") %>% group_by(species) %>% summarize(mean=mean(estimate),median=median(estimate),lower=quantile(probs=0.025,estimate),upper=quantile(probs=0.975,estimate),quantile_l=quantile(estimate)[[1]],quantile_u=quantile(estimate)[[2]]) %>% melt(id.vars='species')\nggplot(pars_detect[pars_detect$par %in% \"beta3\",],aes(x=estimate)) + geom_histogram() + facet_wrap(~species,scales='free',ncol=3) + geom_vline(data=post,aes(xintercept=value,col=variable))\n```\n\n##Traitmatching and Bill Length\n\nDo species with long bill lengths have positive traitmatching effects?\n\n```{r,fig.height=7,fig.width=8}\n#species names\nb<-pars_detect[pars_detect$par %in% \"beta1\",]\nb<-merge(b,jagsIndexBird,by.x=\"species\",by.y=\"jBird\")\n\n#traits\nb<-merge(b,hum.morph,by.x=\"Hummingbird\",by.y=\"English\")\n\npost<-b %>% filter(par %in% \"beta1\") %>% group_by(Hummingbird) %>% summarize(mean=mean(estimate),median=median(estimate),lower=quantile(probs=0.025,estimate),upper=quantile(probs=0.975,estimate),quantile_l=quantile(estimate)[[1]],quantile_u=quantile(estimate)[[2]]) %>% melt(id.vars='Hummingbird')\n\n#get order of mean posterior\nord<-post %>% filter(variable==\"mean\") %>% arrange(value) %>% .$Hummingbird\n\nb$Hummingbird<-factor(b$Hummingbird,levels=ord)\nggplot(b,aes(y=estimate,x=Hummingbird,fill=Total_Culmen)) + geom_violin() + coord_flip() + scale_fill_continuous(low='blue',high='red') + ggtitle(\"Traitmatching and Bill Length\") + theme_bw()\n```\n\n##Interaction and Bill Length\n\nDo species with long bill lengths have positive interaction effects?\n\n```{r,fig.height=7,fig.width=8,eval=F}\n#species names\nb<-pars_detect[pars_detect$par %in% \"beta3\",]\nb<-merge(b,jagsIndexBird,by.x=\"species\",by.y=\"jBird\")\n\n#traits\nb<-merge(b,hum.morph,by.x=\"Hummingbird\",by.y=\"English\")\n\npost<-b %>% filter(par %in% \"beta3\") %>% group_by(Hummingbird) %>% summarize(mean=mean(estimate),median=median(estimate),lower=quantile(probs=0.025,estimate),upper=quantile(probs=0.975,estimate),quantile_l=quantile(estimate)[[1]],quantile_u=quantile(estimate)[[2]]) %>% melt(id.vars='Hummingbird')\n\n#get order of mean posterior\nord<-post %>% filter(variable==\"mean\") %>% arrange(value) %>% .$Hummingbird\n\nb$Hummingbird<-factor(b$Hummingbird,levels=ord)\nggplot(b,aes(y=estimate,x=Hummingbird,fill=Total_Culmen)) + geom_violin() + coord_flip() + scale_fill_continuous(low='blue',high='red') + ggtitle(\"Interaction Effect and Bill Length\") + theme_bw()\n\n```\n\n#Estimated niche breadth\n\n```{r}\ncastdf<-dcast(pars_detect[pars_detect$par %in% c(\"beta1\",\"beta2\",\"beta3\",\"alpha\"),], species +Chain + Draw~par,value.var=\"estimate\")\n\n#Turn to \ncastdf$species<-factor(castdf$species,levels=1:max(as.numeric(castdf$species)))\n\nspecies.split<-split(castdf,list(castdf$species),drop = T)\n\nspecies.traj<-lapply(species.split,function(dat){\n  index<-unique(dat$species)\n  \n  #get data for those species\n  billd<-indat[indat$jBird %in% index,]\n  \n  d<-data.frame(alpha=dat$alpha,beta1=dat$beta1,beta2=dat$beta2,beta3=0)\n  \n  #fit regression for each input estimate\n  sampletraj<-list()\n  \n  for (y in 1:nrow(d)){\n    v=exp(d$alpha[y] + d$beta1[y] * billd$Traitmatch + d$lbeta2[y] * billd$scaledR + d$beta3[y] * billd$Traitmatch*billd$scaledR)\n    \n    sampletraj[[y]]<-data.frame(x=as.numeric(billd$Traitmatch),y=as.numeric(v),r=as.numeric(billd$scaledR),jBird=billd$jBird,jPlant=billd$jPlant,jTime=billd$jTime)\n  }\n  \n  sample_all<-rbind_all(sampletraj)\n})\n  \nspecies.traj<-rbind_all(species.traj)\n```\n\nMean Estimates for Corolla Sizes\n\n```{r}\nspecies.mean<-species.traj %>% group_by(jBird,jPlant,r) %>% summarize(Traitmatch=unique(x),lambda=mean(y))\n\nspecies.mean<-merge(species.mean,indat[,colnames(indat) %in% c(\"jBird\",\"jPlant\",\"jTime\",\"Hummingbird\",\"Iplant_Double\")])\n\n#get corolla sizes\nspecies.mean<-merge(species.mean,fl.morph,by.x=\"Iplant_Double\", by.y=\"Group.1\")\n\nggplot(species.mean) + geom_density2d(aes(x=TotalCorolla,y=lambda,col=Hummingbird)) + theme_bw() + facet_wrap(~r,scales=\"free\") \n#bill order\nord<-hum.morph %>% arrange(Total_Culmen) %>% .$English\nspecies.mean$Hummingbird<-factor(species.mean$Hummingbird,levels=ord)\n\n#add level to hum.morph to match naming convention\nspecies.mean<-merge(species.mean,hum.morph[,c(\"English\",\"Total_Culmen\")],by.x=\"Hummingbird\",by.y=\"English\")\n\np<-ggplot(species.mean,aes(x=TotalCorolla,y=lambda,col=as.factor(BUsed_Flowers))) + geom_line(size=.9) + geom_vline(aes(xintercept=Total_Culmen),linetype='dashed') + facet_wrap(~Hummingbird,ncol=3,scales=\"free_y\")  + theme_bw() + ylab(\"Estimated Daily Interaction Rate\") + scale_color_manual(\"Resource Availability\",labels=c(\"Low\",\"High\"),values=c(\"Blue\",\"Red\")) + xlab(\"Flower Corolla Length (mm)\") \np\nggsave(\"Figures/ResponseCurves.jpeg\",height=6.5,width=9)\n```\n\nDensity curves\n\n```{r}\nggplot(species.mean) + geom_density2d(aes(x=TotalCorolla,y=lambda,col=as.factor(BUsed_Flowers))) + theme_bw() + facet_wrap(~Hummingbird,scales=\"free\",ncol=3)+ scale_color_manual(\"Resources Availability\",labels=c(\"Low\",\"High\"),values=c(\"Blue\",\"Red\")) + ggtitle(\"2D Density Plots\") + geom_vline(aes(xintercept=Total_Culmen),linetype='dashed')\n```\n\n#Niche Breadth \n\n```{r}\nspecies.mean<-species.traj %>% group_by(jBird,jPlant,r) %>% summarize(Traitmatch=unique(x),lambda=mean(y),lambda_low=quantile(y,0.05),lambda_high=quantile(y,0.95))\n\nspecies.mean<-merge(species.mean,indat[,colnames(indat) %in% c(\"jBird\",\"jPlant\",\"jTime\",\"Hummingbird\",\"Iplant_Double\",\" BUsed_Flowers\")])\n\n#get corolla sizes\nspecies.mean<-merge(species.mean,fl.morph,by.x=\"Iplant_Double\", by.y=\"Group.1\")\n\n#bill order\nord<-hum.morph %>% arrange(Total_Culmen) %>% .$English\nspecies.mean$Hummingbird<-factor(species.mean$Hummingbird,levels=ord)\n\n#add level to hum.morph to match naming convention\nspecies.mean<-merge(species.mean,hum.morph[,c(\"English\",\"Total_Culmen\")],by.x=\"Hummingbird\",by.y=\"English\")\n\nggplot(species.mean) + geom_ribbon(alpha=0.2,aes(x=TotalCorolla,ymin=lambda_low,ymax=lambda_high,fill=as.factor(r))) + theme_bw() + facet_wrap(~Hummingbird,scales=\"free\",ncol=3)+ scale_fill_manual(\"Resources Availability\",labels=c(\"Low\",\"High\"),values=c(\"Blue\",\"Red\")) + ggtitle(\"Niche Breadth\") + geom_vline(aes(xintercept=Total_Culmen),linetype='dashed') + geom_line(aes(x=TotalCorolla,y=lambda,fill=as.factor(r))) + ylab(\"Estimated Daily Intensity\") + xlab(\"Corolla Length (mm)\")\nggsave(\"Figures/NicheBreadth.jpeg\",height=6,width=9)\n```\n\nStandardized intensity of niche breadth\n\n```{r}\nsm<-split(species.mean,species.mean$Hummingbird,drop=T)\nsm<-lapply(sm,function(x){\n  x$lambda<-x$lambda/max(x$lambda)\n  x$lambda_low<-x$lambda_low/max(x$lambda_low)\n  x$lambda_high<-x$lambda_high/max(x$lambda_high)\n  return(x)\n})\nspecies.max<-rbind_all(sm)\n\nggplot(species.max,aes(x=TotalCorolla,y=lambda,col=as.factor(BUsed_Flowers))) + geom_density2d() + theme_bw() + scale_color_manual(\"Resources Availability\",labels=c(\"Low\",\"High\"),values=c(\"Blue\",\"Red\")) + scale_y_continuous(breaks=c(0,1),labels=c(\"Low\",\"High\")) + xlab(\"Flower Corolla Length\") + ylab(\"Hummingbird Visitation\")\n```\n\n#Generate network\n\n```{r}\ntrait_model<-matrix(nrow=Birds,ncol=Plants)\ncolnames(trait_model)<-jagsIndexPlants$Iplant_Double\nrownames(trait_model)<-jagsIndexBird$Hummingbird\n\nfor( x in 1:Birds){\n    spdat<-filter(castdf,species==x)\n    draw<-spdat[sample(1:nrow(spdat),1),]\n    \n    #For each plant species create a deviate\n    for (y in 1:Plants){\n      prob=inv.logit(draw$alpha + draw$beta1 * jTraitmatch[x,y])\n      trait_model[x,y]<-rbinom(1,1,prob)\n    }\n}\n\n#calculate network statistic\nnstat<-networklevel(trait_model,index=c(\"connectance\",\"nestedness\"))\n\nplotweb(trait_model)\n```\n\n```{r}\nsave.image(\"ObservedModel.RData\")\n```\n",
    "created" : 1465441667347.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "3566420224",
    "id" : "C8B1B39C",
    "lastKnownWriteTime" : 1465496444,
    "path" : "~/NetworkPredict/Observed2m_model.Rmd",
    "project_path" : "Observed2m_model.Rmd",
    "properties" : {
        "tempName" : "Untitled1"
    },
    "relative_order" : 6,
    "source_on_save" : false,
    "type" : "r_markdown"
}